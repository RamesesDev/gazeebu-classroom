import com.rameses.annotations.*;

class SessionNotifierMessageHandler {
	
	@Service("SessionService")
	def sessionService;
	
	@Service("ClassroomService")
	def classroomService;
	
    @After(pattern="MessageService.send*")
    public def broadcastMessage( def evt ) {
		def r = evt.result;
		if( r.msgtype == "private") {
			sessionService.notifyUser( r.senderid, r );
			r.recipients.each {
				sessionService.notifyUser( it.userid, r );
			}
		}
		else {
			if(r.channelid) {
				def classroom = classroomService.getClassInfo( r.channelid );		
				classroom.members.each {
					sessionService.notifyUser( it.objid, r );
				}
			}
			else {
				sessionService.notifyAllExceptSender( r, r.senderid  );
			}	
		}
    } 
    
    @After(pattern="MessageService.removeMessage*")
	public def broadcastRemoveMessage( def evt ) {
		def r = evt.args[0];
		if(r.channelid) {
			def classroom = classroomService.getClassInfo( r.channelid );		
			classroom.members.each {
				sessionService.notifyUser( it.objid, [msgtype:r.msgtype+"-removed", objid: r.objid, channelid: r.channelid ] );
			}
		}
	}
	
}

